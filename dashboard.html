<!doctype html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Dashboard Kehadiran</title>
    <style>
      :root {
        --gap: 12px;
        --r: 14px;
        --b: #e5e7eb;
        --m: #64748b;
        --ok: #0f766e;
        --bad: #b91c1c;
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, system-ui, sans-serif;
        margin: 0;
        background: #fff;
        padding: 14px;
        max-width: 1200px;
        margin: auto;
      }
      h2 {
        margin: 0 0 6px 0;
      }
      .muted {
        color: var(--m);
      }
      .row {
        display: flex;
        gap: var(--gap);
        flex-wrap: wrap;
        align-items: center;
      }
      select,
      button {
        padding: 12px 14px;
        border-radius: var(--r);
        border: 1px solid #d0d7de;
        font-size: 16px;
        min-height: 48px;
      }
      button {
        cursor: pointer;
        font-weight: 700;
        background: #f8fafc;
      }
      .pill {
        padding: 8px 12px;
        border: 1px solid var(--b);
        border-radius: 999px;
        font-size: 14px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }
      .card {
        border: 1px solid var(--b);
        border-radius: var(--r);
        padding: 12px;
      }
      .bad {
        color: var(--bad);
        font-weight: 800;
      }
      canvas {
        width: 100% !important;
        height: 320px !important;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
        canvas {
          height: 300px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="row" style="justify-content: space-between">
      <div>
        <h2>Dashboard Kehadiran</h2>
        <div class="muted" id="sub">-</div>
      </div>
      <span class="pill" id="live">Live: -</span>
    </div>

    <div class="row" style="margin-top: 10px">
      <select id="days">
        <option value="7">7 hari</option>
        <option value="14" selected>14 hari</option>
        <option value="30">30 hari</option>
        <option value="60">60 hari</option>
      </select>

      <select id="group">
        <option value="keuskupan" selected>Trend per Keuskupan</option>
        <option value="paroki">Trend per Paroki</option>
      </select>

      <select id="top">
        <option value="5">Top 5</option>
        <option value="8" selected>Top 8</option>
        <option value="10">Top 10</option>
        <option value="15">Top 15</option>
      </select>

      <button id="refresh">Refresh</button>
      <button id="auto">Auto: OFF</button>
    </div>

    <div id="err" class="bad" style="margin-top: 10px; display: none"></div>

    <div class="grid">
      <div class="card">
        <b>Jumlah Peserta per Hari (Bar)</b>
        <div class="muted" style="margin-top: 6px">
          Total kehadiran per tanggal (gabungan semua HariKe).
        </div>
        <canvas id="barDaily"></canvas>
      </div>

      <div class="card">
        <b>Trend Kehadiran (Line)</b>
        <div class="muted" style="margin-top: 6px">
          Top keuskupan/paroki (berdasarkan total selama periode).
        </div>
        <canvas id="lineTrend"></canvas>
      </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      // ✅ GANTI URL WEB APP /exec ANDA
      const API =
        "https://script.google.com/macros/s/AKfycbyeNfAvXRsbo1DXc_uEOSweh1cRuMTJyh8c4zXUJoZtg1glKQLLSTsuUfQZcWxpoIxBLw/exec";

      const elSub = document.getElementById("sub");
      const elLive = document.getElementById("live");
      const elErr = document.getElementById("err");

      const selDays = document.getElementById("days");
      const selGroup = document.getElementById("group");
      const selTop = document.getElementById("top");

      const btnRefresh = document.getElementById("refresh");
      const btnAuto = document.getElementById("auto");

      let autoTimer = null;
      let barChart = null;
      let lineChart = null;

      function showErr(msg) {
        elErr.style.display = msg ? "block" : "none";
        elErr.textContent = msg || "";
      }

      async function loadTrend() {
        showErr("");
        elLive.textContent = "Live: loading...";

        const url = new URL(API);
        url.searchParams.set("page", "trend");
        url.searchParams.set("days", selDays.value);
        url.searchParams.set("group", selGroup.value);
        url.searchParams.set("top", selTop.value);

        const res = await fetch(url.toString(), { cache: "no-store" });
        const json = await res.json();

        if (!json.ok) {
          showErr(json.message || "Gagal memuat data trend.");
          elLive.textContent = "Live: error";
          return;
        }

        const labels = json.labels || [];
        const dailyTotal = json.dailyTotal || [];
        const series = json.series || [];

        elSub.textContent = `Periode: ${json.days} hari • Group: ${json.group} • Update: ${new Date().toLocaleString()}`;
        elLive.textContent = "Live: OK";

        // BAR: daily total
        if (barChart) barChart.destroy();
        barChart = new Chart(document.getElementById("barDaily"), {
          type: "bar",
          data: {
            labels,
            datasets: [
              {
                label: "Total per hari",
                data: dailyTotal,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { maxRotation: 0, autoSkip: true } },
              y: { beginAtZero: true },
            },
          },
        });

        // LINE: trend series
        if (lineChart) lineChart.destroy();
        lineChart = new Chart(document.getElementById("lineTrend"), {
          type: "line",
          data: {
            labels,
            datasets: series.map((s) => ({
              label: s.name,
              data: s.data,
              tension: 0.25,
              pointRadius: 2,
            })),
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { maxRotation: 0, autoSkip: true } },
              y: { beginAtZero: true },
            },
          },
        });
      }

      btnRefresh.onclick = loadTrend;

      btnAuto.onclick = () => {
        if (autoTimer) {
          clearInterval(autoTimer);
          autoTimer = null;
          btnAuto.textContent = "Auto: OFF";
          return;
        }
        autoTimer = setInterval(loadTrend, 5000);
        btnAuto.textContent = "Auto: ON (5s)";
        loadTrend();
      };

      selDays.onchange = loadTrend;
      selGroup.onchange = loadTrend;
      selTop.onchange = loadTrend;

      loadTrend();
    </script>
  </body>
</html>
