<!doctype html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Scanner Kehadiran (Petugas)</title>
    <style>
      :root {
        --gap: 12px;
        --radius: 14px;
        --control-h: 56px;
        --font: 18px;
        --pad-x: 14px;
        --border: #e5e7eb;
        --focus: rgba(9, 105, 218, 0.18);
      }
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, system-ui, sans-serif;
        padding: 14px;
        max-width: 980px;
        margin: auto;
        background: #fff;
      }
      .row {
        display: flex;
        gap: var(--gap);
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 12px;
      }
      h2 {
        margin: 0;
      }
      input,
      select,
      button {
        padding: 12px var(--pad-x);
        font-size: var(--font);
        min-height: var(--control-h);
        border-radius: var(--radius);
      }
      input,
      select {
        width: 100%;
        border: 1px solid #d0d7de;
      }
      input:focus,
      select:focus {
        border-color: #0969da;
        box-shadow: 0 0 0 4px var(--focus);
        outline: none;
      }
      button {
        font-weight: 700;
        border: 1px solid #cbd5e1;
        background: #f8fafc;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
      }
      #start {
        background: #0ea5e9;
        color: #fff;
      }
      #stop {
        background: #ef4444;
        color: #fff;
      }
      #syncNow {
        background: #16a34a;
        color: #fff;
      }
      #resetQ {
        background: #64748b;
        color: #fff;
      }
      .pill {
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        font-size: 14px;
      }
      .pill.right {
        margin-left: auto;
      }

      /* Kamera area */
      video {
        width: 100%;
        border-radius: 14px;
        border: 1px solid #ddd;
        margin-top: 10px;
        background: #000;
        object-fit: cover;
        aspect-ratio: 16/9;
      }
      @media (max-width: 700px) {
        video {
          aspect-ratio: 4/5;
        }
      }
      /* html5-qrcode container */
      #reader {
        width: 100%;
        border-radius: 14px;
        border: 1px solid #ddd;
        margin-top: 10px;
        overflow: hidden;
        background: #000;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        margin-top: 12px;
      }
      .ok {
        color: #0f766e;
        font-weight: 800;
      }
      .warn {
        color: #b45309;
        font-weight: 800;
      }
      .bad {
        color: #b91c1c;
        font-weight: 800;
      }
      .hidden {
        display: none;
      }

      .field-pass {
        position: relative;
        width: 100%;
      }
      .field-pass input {
        padding-right: 52px;
      }
      .eye-btn {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 40px;
        height: 40px;
        padding: 0;
        min-height: auto;
        border: none;
        background: transparent;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .eye-btn:focus {
        outline: none;
        box-shadow: 0 0 0 4px var(--focus);
      }
      .eye-ic {
        width: 22px;
        height: 22px;
        fill: #334155;
      }
      pre {
        white-space: pre-wrap;
        margin: 8px 0 0;
        color: #334155;
        font-size: 13px;
        line-height: 1.25rem;
      }
      @media (max-width: 520px) {
        .row > * {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="row">
      <h2>Scanner Kehadiran (Petugas)</h2>
      <span class="pill right" id="cap">Kamera: -</span>
      <span class="pill" id="net">Online</span>
      <span class="pill" id="pend">Pending: 0</span>
      <span class="pill" id="modePill">Mode: -</span>
    </div>

    <div class="row">
      <select id="hari">
        <option value="">Pilih Hari</option>
        <option>Hari-1</option>
        <option>Hari-2</option>
        <option>Hari-3</option>
        <option>Hari-4</option>
        <option>Hari-5</option>
      </select>

      <input
        id="petugas"
        placeholder="Nama Petugas (wajib diisi setiap sesi)"
      />

      <div class="field-pass">
        <input
          id="staffKey"
          type="password"
          placeholder="Kunci Petugas (tidak disimpan)"
        />
        <button
          type="button"
          id="toggleEye"
          class="eye-btn"
          aria-label="Tampilkan/Sembunyikan kunci"
        >
          <svg id="eyeOpen" class="eye-ic hidden" viewBox="0 0 24 24">
            <path
              d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0-2.5a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"
            />
          </svg>
          <svg id="eyeOff" class="eye-ic" viewBox="0 0 24 24">
            <path
              d="M2.3 3.7 3.7 2.3l18 18-1.4 1.4-2.2-2.2A10.9 10.9 0 0 1 12 21C5 21 2 14 2 14a20.2 20.2 0 0 1 4.3-6.1L2.3 3.7zM12 7c7 0 10 7 10 7a19.8 19.8 0 0 1-2.7 4l-3-3a5 5 0 0 0-6.3-6.3l-1.8-1.8A10.7 10.7 0 0 1 12 7z"
            />
          </svg>
        </button>
      </div>

      <button id="start">Mulai Scan</button>
      <button id="stop" disabled>Stop</button>
      <button id="syncNow">Sync Sekarang</button>
      <button id="resetQ">Reset Antrean</button>
    </div>

    <!-- Dua renderer: video (BarcodeDetector) atau reader div (html5-qrcode) -->
    <video id="video" playsinline class="hidden"></video>
    <div id="reader" class="hidden"></div>

    <div class="card">
      <div><b>Status:</b> <span id="status"></span></div>
      <div><b>Token terakhir:</b> <span id="lastToken">-</span></div>

      <div class="hidden" id="debugBox" style="margin-top: 10px">
        <div><b>DEBUG:</b></div>
        <pre id="debug"></pre>
      </div>
      <button id="toggleDebug" style="margin-top: 10px">Tampilkan Debug</button>
    </div>

    <script>
      // =======================
      // WAJIB: GANTI URL WEBAPP /exec ANDA
      // =======================
      const API =
        "https://script.google.com/macros/s/AKfycbzv98b-bj8S8Qs6X9qOYcqEamCFP_AR-104ilA5syJb03c0vwSsdekC1Lg1rcjFjfTV4Q/exec";
      // =======================

      const video = document.getElementById("video");
      const reader = document.getElementById("reader");
      const statusEl = document.getElementById("status");
      const lastTokenEl = document.getElementById("lastToken");
      const capEl = document.getElementById("cap");
      const netEl = document.getElementById("net");
      const pendEl = document.getElementById("pend");
      const modePill = document.getElementById("modePill");

      const hariEl = document.getElementById("hari");
      const petugasEl = document.getElementById("petugas");
      const staffKeyEl = document.getElementById("staffKey");

      const btnStart = document.getElementById("start");
      const btnStop = document.getElementById("stop");
      const btnSyncNow = document.getElementById("syncNow");
      const btnResetQ = document.getElementById("resetQ");

      const btnEye = document.getElementById("toggleEye");
      const eyeOpen = document.getElementById("eyeOpen");
      const eyeOff = document.getElementById("eyeOff");

      const debugBox = document.getElementById("debugBox");
      const debugEl = document.getElementById("debug");
      const btnToggleDebug = document.getElementById("toggleDebug");
      let showDebug = false;

      btnToggleDebug.onclick = () => {
        showDebug = !showDebug;
        debugBox.classList.toggle("hidden", !showDebug);
        btnToggleDebug.textContent = showDebug
          ? "Sembunyikan Debug"
          : "Tampilkan Debug";
      };

      btnEye.onclick = () => {
        const isHidden = staffKeyEl.type === "password";
        staffKeyEl.type = isHidden ? "text" : "password";
        eyeOpen.classList.toggle("hidden", !isHidden);
        eyeOff.classList.toggle("hidden", isHidden);
        staffKeyEl.focus();
      };

      function setStatus(msg, cls = "") {
        statusEl.className = cls;
        statusEl.textContent = msg;
      }
      function setDebug(obj) {
        if (!showDebug) return;
        debugEl.textContent =
          typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
      }
      function extractToken(t) {
        const m = String(t).match(/TOKEN\s*=\s*([A-Za-z0-9-_]+)/i);
        return (m ? m[1] : t).trim();
      }

      // ===== Offline Queue =====
      const QKEY = "ABSEN_QUEUE_V2";
      function loadQueue() {
        try {
          return JSON.parse(localStorage.getItem(QKEY) || "[]");
        } catch {
          return [];
        }
      }
      function saveQueue(q) {
        localStorage.setItem(QKEY, JSON.stringify(q));
        pendEl.textContent = "Pending: " + q.length;
      }
      function enqueue(item) {
        const q = loadQueue();
        q.push(item);
        saveQueue(q);
      }

      // ===== Net =====
      function updateNet() {
        netEl.textContent = navigator.onLine ? "Online" : "Offline";
      }
      window.addEventListener("online", () => {
        updateNet();
        syncQueue();
      });
      window.addEventListener("offline", updateNet);

      // ===== HTTP =====
      async function postForm(obj) {
        const body = new URLSearchParams(obj);
        const res = await fetch(API, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body,
          cache: "no-store",
          redirect: "follow",
        });
        const text = await res.text();
        let json = null;
        try {
          json = JSON.parse(text);
        } catch {}
        return { ok: res.ok, status: res.status, text, json };
      }

      async function getQuery(obj) {
        const url = new URL(API);
        Object.entries(obj).forEach(([k, v]) => url.searchParams.set(k, v));
        const res = await fetch(url.toString(), {
          cache: "no-store",
          redirect: "follow",
        });
        const text = await res.text();
        let json = null;
        try {
          json = JSON.parse(text);
        } catch {}
        return { ok: res.ok, status: res.status, text, json };
      }

      function validateForm() {
        if (!hariEl.value) {
          setStatus("Pilih Hari terlebih dahulu", "bad");
          return false;
        }
        if (!petugasEl.value) {
          setStatus("Nama petugas wajib diisi", "bad");
          return false;
        }
        if (!staffKeyEl.value) {
          setStatus("Kunci petugas wajib diisi", "bad");
          return false;
        }
        return true;
      }

      async function sendToken(token) {
        if (!validateForm()) return;
        lastTokenEl.textContent = token;
        setStatus("Mengirim...");

        const qbytes = (localStorage.getItem(QKEY) || "").length;

        if (!navigator.onLine) {
          enqueue({ token, hari: hariEl.value });
          setStatus("üì¥ Offline. Disimpan ke antrean.", "warn");
          setDebug({
            stage: "offline_queue",
            token,
            queueLen: loadQueue().length,
            queueBytes: qbytes,
          });
          return;
        }

        // POST
        try {
          const r = await postForm({
            token,
            hari: hariEl.value,
            petugas: petugasEl.value,
            k: staffKeyEl.value,
          });
          setDebug({
            stage: "record_post",
            status: r.status,
            ok: r.ok,
            json: r.json,
            text: r.text?.slice(0, 200),
            queueLen: loadQueue().length,
            queueBytes: qbytes,
          });
          if (r.json && r.json.message) {
            const msg = r.json.message;
            setStatus(msg, msg.startsWith("‚úÖ") ? "ok" : "warn");
            return;
          }
        } catch (err) {
          setDebug({
            stage: "record_post_error",
            error: String(err),
            queueBytes: qbytes,
          });
        }

        // GET fallback
        try {
          const g = await getQuery({
            token,
            hari: hariEl.value,
            petugas: petugasEl.value,
            k: staffKeyEl.value,
          });
          setDebug({
            stage: "record_get_fallback",
            status: g.status,
            ok: g.ok,
            json: g.json,
            text: g.text?.slice(0, 200),
            queueLen: loadQueue().length,
            queueBytes: qbytes,
          });
          if (g.json && g.json.message) {
            const msg = g.json.message;
            setStatus(msg, msg.startsWith("‚úÖ") ? "ok" : "warn");
            return;
          }
        } catch (err) {
          setDebug({
            stage: "record_get_error",
            error: String(err),
            queueBytes: qbytes,
          });
        }

        // tetap gagal => antrean
        enqueue({ token, hari: hariEl.value });
        setStatus("‚ö†Ô∏è Gagal kirim. Disimpan ke antrean.", "warn");
      }

      async function syncQueue() {
        if (!validateForm()) return;
        if (!navigator.onLine) {
          setStatus("Masih offline.", "warn");
          return;
        }

        let q = loadQueue();
        if (!q.length) {
          setStatus("Antrean kosong.", "ok");
          return;
        }

        const CHUNK = 50;
        let inserted = 0,
          duplicates = 0,
          failed = 0;

        setStatus("Sync antrean...", "warn");

        while (q.length) {
          const part = q.slice(0, CHUNK);
          try {
            const r = await postForm({
              page: "bulk",
              items: JSON.stringify(part),
              petugas: petugasEl.value,
              k: staffKeyEl.value,
            });

            const qbytes = (localStorage.getItem(QKEY) || "").length;
            setDebug({
              stage: "bulk_chunk",
              chunkSize: part.length,
              status: r.status,
              ok: r.ok,
              json: r.json,
              text: r.text?.slice(0, 200),
              queueLen: q.length,
              queueBytes: qbytes,
            });

            if (!r.json || r.json.ok === false) {
              setStatus(
                "‚õî Sync ditolak: " + (r.json?.message || "unknown"),
                "bad",
              );
              return;
            }

            inserted += r.json.inserted || 0;
            duplicates += r.json.duplicates || 0;
            failed += r.json.failed || 0;

            q = q.slice(part.length);
            saveQueue(q);
          } catch (err) {
            setDebug({ stage: "bulk_chunk_error", error: String(err) });
            setStatus("‚ö†Ô∏è Sync gagal. Coba lagi.", "warn");
            return;
          }
        }

        setStatus(
          `‚úÖ Sync selesai: ${inserted} masuk, ${duplicates} duplikat, ${failed} gagal`,
          "ok",
        );
      }

      btnResetQ.onclick = () => {
        localStorage.removeItem(QKEY);
        saveQueue([]);
        setStatus("‚úÖ Antrean direset.", "ok");
        const qbytes = (localStorage.getItem(QKEY) || "").length;
        setDebug({ stage: "reset_queue", queueLen: 0, queueBytes: qbytes });
      };

      // ======================
      // SCAN ENGINE: BarcodeDetector (Android/desktop) + html5-qrcode fallback (iPhone)
      // ======================
      let engine = "none";
      let scanning = false;

      // BarcodeDetector vars
      let stream = null,
        detector = null,
        lastSeen = "",
        lastAt = 0;

      // html5-qrcode vars
      let html5 = null;

      function pickEngine() {
        if ("BarcodeDetector" in window) return "barcode";
        return "html5";
      }

      // --- html5-qrcode loader (embed minimal)
      // Kita load dari CDN yang stabil: jsdelivr (lebih stabil dari unpkg untuk package ini)
      function loadHtml5Lib_() {
        return new Promise((resolve, reject) => {
          if (window.Html5Qrcode) return resolve();
          const s = document.createElement("script");
          s.src =
            "https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/minified/html5-qrcode.min.js";
          s.onload = () => resolve();
          s.onerror = () =>
            reject(new Error("Gagal load html5-qrcode library"));
          document.head.appendChild(s);
        });
      }

      async function startScan() {
        if (!validateForm()) return;

        engine = pickEngine();
        modePill.textContent =
          "Mode: " +
          (engine === "barcode" ? "BarcodeDetector" : "html5-qrcode");

        scanning = true;
        hariEl.disabled = true;
        btnStart.disabled = true;
        btnStop.disabled = false;

        try {
          if (engine === "barcode") {
            reader.classList.add("hidden");
            video.classList.remove("hidden");

            detector = new BarcodeDetector({ formats: ["qr_code"] });
            stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" },
            });
            video.srcObject = stream;
            await video.play();

            capEl.textContent = "Kamera: aktif";
            setStatus("Kamera aktif. Siap scan.", "ok");

            tickBarcode_();
            return;
          }

          // html5-qrcode (iPhone fallback)
          video.classList.add("hidden");
          reader.classList.remove("hidden");

          await loadHtml5Lib_();
          html5 = new Html5Qrcode("reader");

          capEl.textContent = "Kamera: aktif";
          setStatus("Kamera aktif. Siap scan.", "ok");

          // Portrait box lebih besar
          const qrbox = (vw) => {
            const size = Math.floor(Math.min(vw * 0.78, 320));
            return { width: size, height: size };
          };

          await html5.start(
            { facingMode: "environment" },
            { fps: 20, qrbox, disableFlip: false },
            async (decodedText) => {
              const token = extractToken(decodedText);
              // throttle 1.2s
              const now = Date.now();
              if (token && !(token === lastSeen && now - lastAt < 1200)) {
                lastSeen = token;
                lastAt = now;
                await sendToken(token);
              }
            },
            () => {}, // ignore errors
          );
        } catch (err) {
          setDebug({ stage: "startScan_error", engine, error: String(err) });
          setStatus("‚ùå Kamera gagal dibuka / izin ditolak.", "bad");
          stopScan();
        }
      }

      async function tickBarcode_() {
        if (!scanning || !detector) return;
        try {
          const codes = await detector.detect(video);
          if (codes.length) {
            const token = extractToken(codes[0].rawValue);
            const now = Date.now();
            if (token && !(token === lastSeen && now - lastAt < 1200)) {
              lastSeen = token;
              lastAt = now;
              await sendToken(token);
            }
          }
        } catch (err) {
          setDebug({ stage: "detect_error", error: String(err) });
        }
        requestAnimationFrame(tickBarcode_);
      }

      async function stopScan() {
        scanning = false;
        hariEl.disabled = false;
        btnStart.disabled = false;
        btnStop.disabled = true;

        // stop barcode
        try {
          stream?.getTracks().forEach((t) => t.stop());
        } catch {}
        stream = null;
        detector = null;
        try {
          video.pause();
        } catch {}
        video.srcObject = null;

        // stop html5
        try {
          if (html5) {
            await html5.stop();
            await html5.clear();
          }
        } catch {}
        html5 = null;

        capEl.textContent = "Kamera: -";
        setStatus("Scan dihentikan.", "warn");
      }

      btnStart.onclick = startScan;
      btnStop.onclick = stopScan;
      btnSyncNow.onclick = syncQueue;

      // init
      updateNet();
      saveQueue(loadQueue());
      modePill.textContent =
        "Mode: " +
        (pickEngine() === "barcode" ? "BarcodeDetector" : "html5-qrcode");
      setStatus("Siap. Isi Hari, Nama Petugas, dan Kunci lalu Mulai Scan.");
    </script>
  </body>
</html>
