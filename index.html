<!doctype html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scanner Kehadiran</title>

    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
      body {
        font-family: Arial, system-ui;
        max-width: 900px;
        margin: auto;
        padding: 14px;
        background: #f8fafc;
      }

      button {
        width: 100%;
        padding: 16px;
        font-size: 18px;
        border-radius: 12px;
        border: 0;
        font-weight: bold;
      }

      .start {
        background: #0ea5e9;
        color: white;
      }
      .stop {
        background: #ef4444;
        color: white;
      }
      .sync {
        background: #16a34a;
        color: white;
      }

      video {
        width: 100%;
        border-radius: 14px;
      }

      #reader {
        margin-top: 10px;
      }

      .status {
        margin-top: 10px;
        padding: 12px;
        border-radius: 10px;
        background: white;
        border: 1px solid #e5e7eb;
      }

      .scan-box {
        border: 4px solid #fbbf24;
        border-radius: 20px;
      }
    </style>
  </head>

  <body>
    <h2>Scanner Kehadiran</h2>

    <select id="hari">
      <option value="">Pilih Hari</option>
      <option>Hari-1</option>
      <option>Hari-2</option>
      <option>Hari-3</option>
      <option>Hari-4</option>
      <option>Hari-5</option>
    </select>

    <input id="petugas" placeholder="Nama Petugas" />
    <input id="key" placeholder="Staff Key" />

    <br /><br />

    <button class="start" id="start">Mulai Scan</button>
    <button class="stop" id="stop">Stop</button>
    <button class="sync" id="sync">Sync Sekarang</button>

    <div id="reader"></div>

    <div class="status" id="status">Status: siap</div>

    <script>
      const API =
        "https://script.google.com/macros/s/AKfycbx1cTP5e0OY7JEUo_KnrM5KxpHYFKjRUWcD7jtie0GZerpXEcux-W9N-Bd87uZwXLfTJA/exec";

      const statusEl = document.getElementById("status");

      function setStatus(t) {
        statusEl.innerHTML = "Status: " + t;
      }

      function extractToken(t) {
        const m = String(t).match(/TOKEN\s*=\s*([A-Za-z0-9-_]+)/i);
        return m ? m[1] : t;
      }

      function queuePush(item) {
        let q = JSON.parse(localStorage.getItem("queue") || "[]");
        q.push(item);
        localStorage.setItem("queue", JSON.stringify(q));
      }

      function queueGet() {
        return JSON.parse(localStorage.getItem("queue") || "[]");
      }

      function queueClear() {
        localStorage.removeItem("queue");
      }

      async function postForm(obj) {
        const body = new URLSearchParams(obj);

        const res = await fetch(API, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body,
        });

        return res.json();
      }

      async function sendToken(token) {
        try {
          const data = await postForm({
            token,
            hari: hari.value,
            petugas: petugas.value,
            k: key.value,
          });

          if (data.ok) {
            setStatus("✅ " + data.message);
          } else {
            setStatus("⚠️ " + data.message);
          }
        } catch (e) {
          queuePush({
            token,
            hari: hari.value,
          });

          setStatus("⚠️ Gagal kirim. Disimpan ke antrean.");
        }
      }

      async function syncQueue() {
        let q = queueGet();

        if (!q.length) {
          setStatus("Tidak ada antrean.");
          return;
        }

        try {
          const data = await postForm({
            page: "bulk",
            items: JSON.stringify(q),
            petugas: petugas.value,
            k: key.value,
          });

          if (data.ok) {
            queueClear();
            setStatus("✅ Sync berhasil.");
          } else {
            setStatus("⚠️ Sync gagal.");
          }
        } catch (e) {
          setStatus("⚠️ Server tidak bisa dihubungi.");
        }
      }

      let scanner;

      document.getElementById("start").onclick = async () => {
        scanner = new Html5Qrcode("reader");

        await scanner.start(
          { facingMode: "environment" },
          {
            fps: 20,
            qrbox: { width: 250, height: 250 },
          },
          (decoded) => {
            const token = extractToken(decoded);

            sendToken(token);
          },
        );
      };

      document.getElementById("stop").onclick = async () => {
        if (scanner) await scanner.stop();
      };

      document.getElementById("sync").onclick = syncQueue;
    </script>
  </body>
</html>
